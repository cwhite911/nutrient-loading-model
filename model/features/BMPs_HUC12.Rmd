---
title: "HUC12_BMP_Feature_Creation"
author: "Corey White"
date: "11/18/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Nutrient Loading Model

```{r libs, include=FALSE}
library(reshape2) # (tidy) R provides a variety of methods for reshaping data prior to analysis.
library(dplyr) # (tidy) dplyr is a grammar of data manipulation, providing a consistent set of verbs that help you solve the most common data manipulation challenges:
# library(lme4) # lme4 provides functions for fitting and analyzing mixed models: linear (lmer), generalized linear(glmer) and nonlinear (nlmer.)
library(ggplot2) # (tidy) gplot2 is a system for declaratively creating graphics
# library(xlsx) # Provide R functions to read/write/format Excel 2007 and Excel 97/2000/XP/2003 file formats.
# library(rstan) # Stan is a state-of-the-art platform for statistical modeling and high-performance statistical computation. 
library(rstudioapi) # Access the RStudio API (if available) and provide informative error messages when it's not.
# library(loo)  # Efficient Leave-One-Out Cross-Validation and WAIC for Bayesian Models
library(MASS) # Support Functions and Datasets for Venables and Ripley's MASS
# library(rcompanion) # Functions to Support Extension Education Program Evaluation
library(ggpubr) # 'ggplot2' Based Publication Ready Plots
# library(matrixStats) # Functions that Apply to Rows and Columns of Matrices (and to Vectors)
library(pacman) # Package Management Tool
library(cowplot) # add-on to ggplot. It provides various features that help with creating publication-quality figures, such as a set of themes, functions to align plots and arrange them into complex compound figures, and functions that make it easy to annotate plots and or mix plots with images.
library(hexbin) # Bivariate Binning Into Hexagon Cells
library(RColorBrewer)
library(rgeos)
require(gridExtra)

```

## Import Configuration file
```{r}
config <- config::get(file = "model/config.yml")
```

### Connect to database
```{r connect, message=F, warning=F}
library(RPostgreSQL)
library(postGIStools)
library(RColorBrewer)

con <- dbConnect(PostgreSQL(), dbname = "WRRI", user = "postgres",
                 host = "localhost",
                 port="5432")
```

## HUC12 Subwatersheds

```{r}
library(rgdal)
huc12 <- readOGR(dsn = paste(config$data, config$huc12, sep="/"), layer = config$huc12, stringsAsFactors = F)
head(huc12)
```
```{r}
plot(huc12)
```


```{r}
huc12@data$basin <- as.factor(huc12$basin)                              # Convert character vector to factor
retention_plot <- spplot(huc12, "retention", col.regions=rev(brewer.pal(7,'Spectral')), cuts=6, main="HUC12 Retention")
area_plot <- spplot(huc12, "Area", col.regions=rev(brewer.pal(7,'Spectral')), cuts=6, main="HUC12 Area")
basin_plot <- spplot(huc12, "basin", col.regions=rev(brewer.pal(7,'Spectral')), cuts=6, main="HUC12 Basin Membership")
plot_grid(basin_plot,
          area_plot,
          retention_plot, 
          align = "hv", ncol = 3)
```


```{r}
spplot(huc12, c("Area","basin", "retention"), col.regions=rev(brewer.pal(7,'Spectral')), cuts=6, main="HUC12 by Basin", scales = list(draw = TRUE))
```


## Stream buffers

Analyzing stream buffers, ponds, other BMPs provided by the municipalities, building footprints and NLCD data.

```{r streambufs}
paste(config$data, config$streambuffer$file, sep="/")

stream_buffers_gpkg <- readOGR(paste(config$data, config$streambuffer$file, sep="/"), stringsAsFactors = F)

```

```{r}
huc12_buffers_30m <- gIntersection(huc12, stream_buffers_gpkg)
plot(huc12, col=c('grey'))
plot(huc12_buffers_30m, col=c('blue'), add=T)

```

## ponds

```{r ponds, echo=FALSE}

```

## BMPs

```{r bmps, echo=TRUE}

```

## Building Footprints

```{sql bfootprint_view_sql}

CREATE VIEW huc12_blds_in_strbuff AS (
    WITH hu12_buildings AS (
        -- Spatial join huc12 and building footprints to be used in aggregation query
        SELECT hu12.huc_12, hu12.hu_12_name, bf.bldg_id, bf.year_built,
            bf.occup_type,ST_AREA(ST_SetSRID(bf.geom, 6542)) as total_area,
            (bf.htd_sq_ft / 10.764) as htd_sq_m, --convert to meters
            ST_SetSRID(bf.geom, 6542) as bf_geom, hu12.geom as hu12_geom
        FROM huc_12 as hu12
        JOIN building_footprints as bf
            -- Convert building to center point and us that to determine which subwatershed a building is in.
            ON ST_Contains(hu12.geom, ST_CENTROID(ST_SetSRID(bf.geom, 6542)))
    )

    -- Aggregate builing footprints in each huc12 if they intersect the stream buffer.
    SELECT hu_bld.huc_12,hu_bld.hu_12_name,hu_bld.year_built,
        COUNT(hu_bld.bldg_id) as new_buildings,
        sum(count(hu_bld.bldg_id)) OVER (PARTITION BY hu_bld.hu_12_name ORDER BY hu_bld.hu_12_name, hu_bld.year_built asc rows between unbounded preceding and current row) AS total_buildings,
        (sum(sum(hu_bld.total_area)) OVER (ORDER BY hu_bld.hu_12_name, hu_bld.year_built)/ 1e6) as total_building_sq_km,
        (sum(sum(hu_bld.htd_sq_m)) OVER (ORDER BY hu_bld.hu_12_name, hu_bld.year_built) / 1e6) as total_heated_sq_km,
        hu_bld.hu12_geom
    FROM hu12_buildings as hu_bld, stream_buffers_30m as sb
    WHERE ST_INTERSECTS(hu_bld.bf_geom, sb.geom) --AND hu_bld.hu_12_name = 'Crooked Creek-Eno River'
    GROUP BY hu_bld.huc_12,hu_bld.hu_12_name,hu_bld.year_built, hu_bld.hu12_geom
    ORDER BY hu_bld.hu_12_name, hu_bld.year_built ASC																					
)


```

```{r bfootprints, echo=TRUE}

hu12_building_footprints_df <- get_postgis_query(con, 
    "SELECT * FROM huc12_blds_in_strbuff",
geom_name = "geom")

```

## NLCD

```{r nlcd, echo=TRUE}

```