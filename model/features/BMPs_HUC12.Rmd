---
title: "HUC12_BMP_Feature_Creation"
author: "Corey White"
date: "11/18/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Nutrient Loading Model

```{r libs, include=FALSE}
library(reshape2) # (tidy) R provides a variety of methods for reshaping data prior to analysis.
library(dplyr) # (tidy) dplyr is a grammar of data manipulation, providing a consistent set of verbs that help you solve the most common data manipulation challenges:
# library(lme4) # lme4 provides functions for fitting and analyzing mixed models: linear (lmer), generalized linear(glmer) and nonlinear (nlmer.)
library(ggplot2) # (tidy) gplot2 is a system for declaratively creating graphics
# library(xlsx) # Provide R functions to read/write/format Excel 2007 and Excel 97/2000/XP/2003 file formats.
# library(rstan) # Stan is a state-of-the-art platform for statistical modeling and high-performance statistical computation. 
library(rstudioapi) # Access the RStudio API (if available) and provide informative error messages when it's not.
# library(loo)  # Efficient Leave-One-Out Cross-Validation and WAIC for Bayesian Models
library(MASS) # Support Functions and Datasets for Venables and Ripley's MASS
# library(rcompanion) # Functions to Support Extension Education Program Evaluation
library(ggpubr) # 'ggplot2' Based Publication Ready Plots
# library(matrixStats) # Functions that Apply to Rows and Columns of Matrices (and to Vectors)
library(pacman) # Package Management Tool
library(cowplot) # add-on to ggplot. It provides various features that help with creating publication-quality figures, such as a set of themes, functions to align plots and arrange them into complex compound figures, and functions that make it easy to annotate plots and or mix plots with images.
library(hexbin) # Bivariate Binning Into Hexagon Cells
library(RColorBrewer)
library(rgeos)
require(gridExtra)

```

## Import Configuration file
```{r}
config <- config::get(file = "model/config.yml")
```

### Connect to database
```{r connect, message=F, warning=F}
library(RPostgreSQL)
library(postGIStools)
library(RColorBrewer)

con <- dbConnect(PostgreSQL(), dbname = "WRRI", user = "postgres",
                 host = "postgis",
                 port="5432")
```
### Test Connection
```{r}
dbListTables(con) 
```

**List all tables, and identify geometry column and type for each table**

```{r}
table_info <- get_postgis_query(con, 
  "SELECT f_table_name as table, f_geometry_column as geometry_column, srid, type
  FROM geometry_columns 
  WHERE f_table_schema = 'public' 
  AND f_geometry_column = 'geom'"
)

table_info

```

## HUC12 Subwatersheds

```{r}
library(rgdal)
huc12 <- readOGR(dsn = paste(config$data, config$huc12, sep="/"), layer = config$huc12, stringsAsFactors = F)
head(huc12)

```

```{r}
plot(huc12)
```

```{r}
hu12_df <- get_postgis_query(con, "SELECT * FROM huc_12 WHERE basin IN ('CPF', 'NEU')",
geom_name = "geom")
```

```{r}
spplot(hu12_df)
```


```{r}
huc12_df@data$basin <- as.factor(huc12$basin)                              # Convert character vector to factor
retention_plot <- spplot(huc12_df, "retention", col.regions=rev(brewer.pal(7,'Spectral')), cuts=6, main="HUC12 Retention")
area_plot <- spplot(huc12_df, "Area", col.regions=rev(brewer.pal(7,'Spectral')), cuts=6, main="HUC12 Area")
basin_plot <- spplot(huc12_df, "basin", col.regions=rev(brewer.pal(7,'Spectral')), cuts=6, main="HUC12 Basin Membership")
plot_grid(basin_plot,
          area_plot,
          retention_plot, 
          align = "hv", ncol = 3)
```


```{r}
spplot(huc12, c("Area","basin", "retention"), col.regions=rev(brewer.pal(7,'Spectral')), cuts=6, main="HUC12 by Basin", scales = list(draw = TRUE))
```


## Stream buffers

Analyzing stream buffers, ponds, other BMPs provided by the municipalities, building footprints and NLCD data.

```{r streambufs}


```

```{r}
huc12_buffers_30m <- gIntersection(huc12, stream_buffers_gpkg)
plot(huc12, col=c('grey'))
plot(huc12_buffers_30m, col=c('blue'), add=T)

```

## ponds

```{r ponds, echo=FALSE}

```

## BMPs

```{r bmps, echo=TRUE}

```

## Building Footprints

### Aggregated view of building footprints found in the 30m stream buffer by HUC12.

```{sql bfootprint_view_sql}

CREATE VIEW huc12_blds_in_strbuff AS (
    WITH hu12_buildings AS (
        -- Spatial join huc12 and building footprints to be used in aggregation query
        SELECT hu12.huc_12, hu12.hu_12_name, bf.bldg_id, bf.year_built,
            bf.occup_type,ST_AREA(ST_SetSRID(bf.geom, 6542)) as total_area,
            (bf.htd_sq_ft / 10.764) as htd_sq_m, --convert to meters
            ST_SetSRID(bf.geom, 6542) as bf_geom, hu12.geom as hu12_geom
        FROM huc_12 as hu12
        JOIN building_footprints as bf
            -- Convert building to center point and us that to determine which subwatershed a building is in.
            ON ST_Contains(hu12.geom, ST_CENTROID(ST_SetSRID(bf.geom, 6542)))
    )

    -- Aggregate builing footprints in each huc12 if they intersect the stream buffer.
    SELECT hu_bld.huc_12,hu_bld.hu_12_name,hu_bld.year_built,
        COUNT(hu_bld.bldg_id) as new_buildings,
        sum(count(hu_bld.bldg_id)) OVER (PARTITION BY hu_bld.hu_12_name ORDER BY hu_bld.hu_12_name, hu_bld.year_built asc rows between unbounded preceding and current row) AS total_buildings,
        (sum(sum(hu_bld.total_area)) OVER (ORDER BY hu_bld.hu_12_name, hu_bld.year_built)/ 1e6) as total_building_sq_km,
        (sum(sum(hu_bld.htd_sq_m)) OVER (ORDER BY hu_bld.hu_12_name, hu_bld.year_built) / 1e6) as total_heated_sq_km,
        hu_bld.hu12_geom as geom
    FROM hu12_buildings as hu_bld, stream_buffers_30m as sb
    WHERE ST_INTERSECTS(hu_bld.bf_geom, sb.geom) --AND hu_bld.hu_12_name = 'Crooked Creek-Eno River'
    GROUP BY hu_bld.huc_12,hu_bld.hu_12_name,hu_bld.year_built, hu_bld.hu12_geom
    ORDER BY hu_bld.hu_12_name, hu_bld.year_built ASC																					
)


```

```{r bfootprints, echo=TRUE}

hu12_building_footprints_30m_stream_buff_df <- get_postgis_query(con, 
    "SELECT * FROM huc12_blds_in_strbuff WHERE hu_12_name = 'Back Creek' AND year_built >= '1970'",
geom_name = "geom")

head(hu12_building_footprints_30m_stream_buff_df)
```
```{r}
hu12_building_footprints_df <- get_postgis_query(con, 
    "SELECT * FROM huc12_blds WHERE hu_12_name = 'Back Creek' AND year_built >= '1970' AND dwq_basin = 'Cape Fear'",
geom_name = "geom")

head(hu12_building_footprints_df)
```

```{r}
hu12_building_footprints_df@data$year_built <- as.Date(as.character(hu12_building_footprints_df@data$year_built), format = "%Y")
hu12_building_footprints_30m_stream_buff_df@data$year_built <- as.Date(as.character(hu12_building_footprints_30m_stream_buff_df@data$year_built), format = "%Y")
ggplot() + 
  geom_line(data = hu12_building_footprints_30m_stream_buff_df@data, aes(x = year_built, y = total_buildings), color = "red") +
  geom_point(data = hu12_building_footprints_30m_stream_buff_df@data, aes(x = year_built, y = total_buildings), color = "red") +
  geom_line(data = hu12_building_footprints_df@data, aes(x = year_built, y = total_buildings), color = "blue") +
  geom_point(data = hu12_building_footprints_df@data, aes(x = year_built, y = total_buildings), color = "blue") +
  #xlab('Year Built') +
  #ylab('Total Buildings') +
  labs(color="Buiding Inclusion",
       title = "Total Buildings in the Back Creek Subwatershed (HUC12)",
       subtitle = "Cape Fear River Basin (1970 - 2014)",
       x = "Year Built",
       y = "Total Buildings") + theme(legend.position = "bottom")
```

```{r}
hu12_building_footprints_df@data$year_built <- as.Date(as.character(hu12_building_footprints_df@data$year_built), format = "%Y")
hu12_building_footprints_30m_stream_buff_df@data$year_built <- as.Date(as.character(hu12_building_footprints_30m_stream_buff_df@data$year_built), format = "%Y")
ggplot() + 
  geom_line(data = hu12_building_footprints_30m_stream_buff_df@data, aes(x = year_built, y = total_buildings), color = "red") +
  geom_point(data = hu12_building_footprints_30m_stream_buff_df@data, aes(x = year_built, y = total_buildings), color = "red") +
  labs(color="Buiding Inclusion",
       title = "Total Buildings inside 30m Stream Buffer in the Back Creek (HUC12)",
       subtitle = "1970 - 2014",
       x = "Year Built",
       y = "Total Buildings") + theme(legend.position = "bottom")
```




```{r}
ggplot() + 
  geom_line(data = hu12_building_footprints_30m_stream_buff_df@data, aes(x = year_built, y = new_buildings), color = "red") +
  geom_point(data = hu12_building_footprints_30m_stream_buff_df@data, aes(x = year_built, y = new_buildings), color = "red") +
  geom_line(data = hu12_building_footprints_df@data, aes(x = year_built, y = new_buildings), color = "blue") +
  geom_point(data = hu12_building_footprints_df@data, aes(x = year_built, y = new_buildings), color = "blue") +
  #xlab('Year Built') +
  #ylab('Total Buildings') +
  labs(color="Buiding Inclusion",
       title = "New Buildings in the Back Creek Subwatershed (HUC12)",
       subtitle = "Cape Fear River Basin (1970 - 2014)",
       x = "Year Built",
       y = "Total Buildings") + theme(legend.position = "bottom")
```



```{r}
#colour = variable, group = variable
hu12_building_footprints_df@data$year_built <- as.Date(as.character(hu12_building_footprints_df@data$year_built), format = "%Y")
ggplot(hu12_building_footprints_df@data, aes(x = year_built, y = new_buildings, colour= dwq_basin)) +
  facet_wrap(~hu_12_name) +
  geom_point() +
  geom_line() + 
  #scale_colour_brewer(palette="Spectral", direction=-1) +
  scale_x_date(breaks = hu12_building_footprints_df@data$year_built) + 
  theme(axis.text.x = element_text(angle = 90))
```

```{r}


```


```{r}
sptmp_df <- data.frame(matrix(ncol = 42, nrow = 0))
colnames(sptmp_df) <- 1970:2011
#rownames(sptmp_df) <- c("Back Creek")
sptmp_df
sptmp_df[nrow(sptmp_df) + 1,] = hu12_building_footprints_df@data$new_buildings
sptmp_df
length(sptmp_df)
```

```{r}
hu12_df <- get_postgis_query(con, 
    "SELECT fid, geom FROM wbd_huc_10_12 WHERE hu_12_name = 'Back Creek' AND dwq_basin = 'Cape Fear'",
geom_name = "geom")
```



```{r}
#unique(hu12_building_footprints_df@data$year_built)
library(lattice)
library(spacetime)
library(xts)

yrs <- 1970:2011 #unique(hu12_building_footprints_df@data$year_built) #1970:2015
time <- as.POSIXct(paste(yrs, "-12-07", sep=""), tz = "GMT")

#nrow(object@data) == length(object@sp) * nrow(object@time)
nrow(hu12_building_footprints_df@data)
length(hu12_df)
length(time)
hu12_building_footprints_df.st <- STFDF(hu12_df, time,data=hu12_building_footprints_df@data )
hu12_building_footprints_df.st[,,"total_buildings"]
stplot(hu12_building_footprints_df.st[,,"total_buildings"], yrs)


#R> # deselect District of Columbia, polygon 8, which is not present in Produc:
#R> Produc.st = STFDF(states[-8], time, Produc[order(Produc[2], Produc[1]),])
#R> library(RColorBrewer)
#R> stplot(Produc.st[,,"unemp"], yrs, col.regions = brewer.pal(9, "YlOrRd"),cuts=9)
```


```{r}
data("Produc", package = "plm")
Produc[1:5,1:9]

library(maps)
states.m = map('state', plot=FALSE, fill=TRUE)
IDs <- sapply(strsplit(states.m$names, ":"), function(x) x[1])
library(maptools)

states = map2SpatialPolygons(states.m, IDs=IDs)

yrs = 1970:1986
time = as.POSIXct(paste(yrs, "-01-01", sep=""), tz = "GMT")
#When combining all this information, we do not need to reorder states because states and Produc order states alphabetically. #We need to de-select District of Columbia, which is not present in Produc:
# deselect District of Columbia, polygon 8, which is not present in Produc:
library(spacetime)
length(time)
length(states[-8])
nrow(Produc[order(Produc[2], Produc[1]),])
Produc.st = STFDF(states[-8], time, Produc[order(Produc[2], Produc[1]),])
library(RColorBrewer)
# Produc.st[,,"unemp"] - Don't run this 
stplot(Produc.st[,,"unemp"], yrs, col.regions = brewer.pal(9, "YlOrRd"), cuts = 9)
```


## NLCD

```{r nlcd, echo=TRUE}
head(hu12_building_footprints_df@data,100)

```